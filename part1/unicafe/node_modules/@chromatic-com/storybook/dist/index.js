'use strict';

var fs = require('fs');
var path = require('path');
var node = require('chromatic/node');
var filesize = require('filesize');
var jsonfile = require('jsonfile');

var v=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(r,e)=>(typeof require<"u"?require:r)[e]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')});var {CHROMATIC_INDEX_URL:Z,CHROMATIC_BASE_URL:E=Z||"https://www.chromatic.com",CHROMATIC_API_URL:le=`${E}/api`}=process.env,w="@chromatic-com/storybook",a="chromaui/addon-visual-tests",R=`${a}/configInfo`,B=`${a}/gitInfo`,k=`${a}/gitInfoError`,L=`${a}/projectInfo`,A=`${a}/startBuild`,N=`${a}/stopBuild`,x=`${a}/localBuildProgress`,U=`${a}/removeAddon`,F={autoAcceptChanges:!1,exitOnceUploaded:!1,exitZeroOnChanges:!0,forceRebuild:!0,fromCI:!1,isLocalBuild:!0,skip:!1,interactive:!1};var h=t=>I.includes(t),j=t=>["upload","snapshot"].includes(t),I=["initialize","build","upload","verify","snapshot"],y={initialize:{key:"initialize",emoji:"\u{1F680}",renderName:()=>"Initialize build",renderProgress:()=>"Initializing build...",renderComplete:()=>"Initialized",estimateDuration:2e3},build:{key:"build",emoji:"\u{1F3D7}",renderName:()=>"Build Storybook",renderProgress:()=>"Building your Storybook...",renderComplete:()=>"Storybook built",estimateDuration:2e4},upload:{key:"upload",emoji:"\u{1F4E1}",renderName:()=>"Publish your Storybook",renderProgress:({stepProgress:t})=>{let{numerator:r,denominator:e}=t.upload;if(!e||!r)return "Uploading files...";let{value:o,exponent:n}=filesize.filesize(e,{output:"object",round:1}),{value:s,symbol:i}=filesize.filesize(r,{exponent:n,output:"object",round:1});return `Uploading files (${s}/${o} ${i})...`},renderComplete:()=>"Publish complete",estimateDuration:2e4},verify:{key:"verify",emoji:"\u{1F50D}",renderName:()=>"Verify your Storybook",renderProgress:()=>"Verifying contents...",renderComplete:()=>"Storybook verified",estimateDuration:2e4},snapshot:{key:"snapshot",emoji:"\u{1F4F8}",renderName:()=>"Run visual tests",renderProgress:({stepProgress:t})=>{let{numerator:r,denominator:e}=t.snapshot;return e?`Running visual tests (${r}/${e})...`:"Running visual tests..."},renderComplete:()=>"Tested your stories",estimateDuration:9e4},aborted:{key:"aborted",emoji:"\u270B",renderName:()=>"Build canceled",renderProgress:()=>"Build canceled",renderComplete:()=>"Build canceled",estimateDuration:0},complete:{key:"complete",emoji:"\u{1F389}",renderName:()=>"Visual tests completed!",renderProgress:()=>"Visual tests completed!",renderComplete:()=>"Visual tests completed!",estimateDuration:0},error:{key:"error",emoji:"\u{1F6A8}",renderName:()=>"Build failed",renderProgress:()=>"Build failed",renderComplete:()=>"Build failed",estimateDuration:0},limited:{key:"error",emoji:"\u{1F6A8}",renderName:()=>"Build limited",renderProgress:()=>"Build limited",renderComplete:()=>"Build limited",estimateDuration:0}},G={buildProgressPercentage:0,currentStep:I[0],stepProgress:Object.fromEntries(I.map(t=>[t,{}]))};var M=2e3,b,ee=(t,r)=>{if(!h(t))throw new Error(`Unknown step: ${t}`);let e=I.map(p=>{let{startedAt:c,completedAt:f}=r?.[p]||{};return c&&f?f-c:y[p].estimateDuration}),o=e.reduce((p,c)=>p+c,0),n=I.indexOf(t),s=e.slice(0,n).reduce((p,c)=>p+c,0),i=s+e[n],d=s/o*100,l=i/o*100;return {...y[t],startPercentage:d,endPercentage:l,stepPercentage:l-d}},S=(t,r)=>(e,{progress:o,total:n}={})=>{if(clearTimeout(r),!h(e.task))return;if(!t.value)throw new Error("Unexpected missing value for localBuildProgress");let{buildProgressPercentage:s,stepProgress:i,previousBuildProgress:d}=t.value;if(i[e.task]?.completedAt)return;let{startPercentage:l,endPercentage:p,stepPercentage:c}=ee(e.task,d),f=l;if(o&&n&&(f+=c*(o/n)),!j(e.task)){let{estimateDuration:u}=y[e.task],C=I.indexOf(e.task);f=Math.max(f,s)+M/u*c,r=setTimeout(()=>{if(!t.value)throw new Error("Unexpected missing value for localBuildProgress");let{currentStep:g}=t.value;h(g)&&I.indexOf(g)<=C&&S(t,r)(e);},M);}i[e.task]={startedAt:Date.now(),...i[e.task],...o&&n&&{numerator:o,denominator:n}},t.value={buildId:e.announcedBuild?.id,branch:e.git?.branch,buildProgressPercentage:Math.min(f,p),currentStep:e.task,stepProgress:i};},V=(t,r)=>(e,o)=>{if(clearTimeout(r),!t.value)throw new Error("Unexpected missing value for localBuildProgress");let{buildProgressPercentage:n,stepProgress:s}=t.value,i={buildId:e.announcedBuild?.id,branch:e.git?.branch,buildProgressPercentage:n,stepProgress:s,previousBuildProgress:s};if(o){t.value={...i,currentStep:b?.signal.aborted?"aborted":"error",formattedError:o.formattedError,originalError:o.originalError};return}e.task&&h(e.task)&&(s[e.task]={...s[e.task],completedAt:Date.now()}),e.task==="verify"&&e.build?.wasLimited&&(t.value={...i,currentStep:"limited",stepProgress:s,errorDetailsUrl:e.build?.app.account?.billingUrl}),e.build&&e.task==="snapshot"&&(t.value={...i,buildProgressPercentage:100,currentStep:"complete",stepProgress:s,changeCount:e.build.changeCount,errorCount:e.build.errorCount});},K=async(t,r)=>{if(!r.projectId)throw new Error("Missing projectId");if(!r.userToken)throw new Error("Missing userToken");t.value=G;let e;b?.abort(),b=new AbortController,process.env.SB_TESTBUILD="true",await node.run({flags:{interactive:!1},options:{...r,...F,experimental_onTaskStart:S(t,e),experimental_onTaskProgress:S(t,e),experimental_onTaskComplete:V(t,e),experimental_onTaskError:V(t,e),experimental_abortSignal:b?.signal}});},z=()=>{b?.abort(new Error("Build canceled from Storybook"));};var H="experimental_useSharedState_getValue",T="experimental_useSharedState_setValue",D=new Map,m=class{constructor(r){this.channel=r,this.listeners=[],this.state={},this.channel.on(T,(e,o,n)=>{this.state?.[e]?.index>=n||(this.state[e]={index:n,value:o});}),this.channel.on(H,e=>{let o=this.state[e]?.index??0,n=this.state[e]?.value;this.channel.emit(T,e,n,o);});}get(r){return this.state[r]||this.channel.emit(H,r),this.state[r]?.value}set(r,e){let o=(this.state[r]?.index??0)+1;this.state[r]={index:o,value:e},this.channel.emit(T,r,e,o);}static subscribe(r,e){let o=D.get(r)||new m(e);return D.has(r)||(D.set(r,o),o.channel.on(T,(n,s)=>{n===r&&o.listeners.forEach(i=>i(s));})),{get value(){return o.get(r)},set value(n){o.set(r,n);},on(n,s){if(n!=="change")throw new Error("unsupported event");o.listeners.push(s);},off(n,s){if(n!=="change")throw new Error("unsupported event");let i=o.listeners.indexOf(s);i>=0&&o.listeners.splice(i,1);}}}};async function Y(t,r){await jsonfile.writeFile(t,r,{spaces:2});}function oe(t=[]){return [...t,v.resolve("./manager.mjs")]}var q=(t,r,e)=>Object.fromEntries(Object.entries(e).map(([o,n])=>[o,n===r[o]?null:n]).filter(([o,n])=>n!==null||t[o]!==void 0)),ne=async(t,r)=>{let e={storybookBaseDir:".",storybookConfigDir:".storybook"},o={},n={},{repositoryRootDir:s}=await node.getGitInfo(),i=s&&path.normalize(path.relative(s,process.cwd()));i!==path.normalize(t.storybookBaseDir??"")&&(o.storybookBaseDir=i);let d=path.normalize(path.relative(process.cwd(),r.configDir));return d!==path.normalize(t.storybookConfigDir??"")&&(o.storybookConfigDir=d),t.zip||(n.zip=!0),{configuration:t,problems:q(t,e,o),suggestions:q(t,e,n)}},ie=async(t,r,e,o)=>{let n,s,i,d=async()=>{try{let l=await node.getGitInfo();Object.entries(l).some(([p,c])=>n?.[p]!==c)&&r(l,n),n=l,s=void 0,i=setTimeout(d,t);}catch(l){e(l),o&&s?.message!==l.message&&(console.error(`Failed to fetch git info, with error:
${l}`),n=void 0,s=l),i=setTimeout(d,t);}};return d(),()=>clearTimeout(i)},se=async(t,r)=>{let e=await node.getConfiguration(t);await r(e),e.configFile&&fs.watch(e.configFile,async(o,n)=>{n&&await r(await node.getConfiguration(n));});};async function ae(t,r){let{configFile:e,presets:o}=r,n=o.apply("experimental_serverAPI"),{projectId:s}=await node.getConfiguration(e),i=m.subscribe(L,t);i.value=s?{projectId:s}:{};let d=s;i.on("change",async({projectId:u}={})=>{if(!u||u===d)return;d=u;let C=e;try{let{configFile:g,...X}=await node.getConfiguration(C),O=g||C||"chromatic.config.json";await Y(O,{...X,projectId:u,zip:!0}),i.value={...i.value,written:!0,configFile:O};}catch(g){console.warn(`Failed to update your main configuration:

 ${g}`),i.value={...i.value,written:!1,configFile:C};}});let l=m.subscribe(x,t);t.on(A,async({accessToken:u})=>{let{projectId:C}=i.value||{};try{await K(l,{configFile:e,projectId:C,userToken:u});}catch(g){console.error(`Failed to run Chromatic build, with error:
${g}`);}}),t.on(N,z),t.on(U,()=>n.then(u=>u.removeAddon(w)).catch(u=>console.error(u)));let p=m.subscribe(R,t),c=m.subscribe(B,t),f=m.subscribe(k,t);return ie(5e3,u=>{f.value=void 0,c.value=u;},u=>{f.value=u;}),se(e,async u=>{d&&(p.value=await ne(u,r));}),setInterval(()=>t.emit(`${a}/heartbeat`),1e3),t}var ue={managerEntries:oe,experimental_serverChannel:ae,env:async(t,{configType:r})=>r==="PRODUCTION"?t:{...t,CHROMATIC_BASE_URL:E}},Ge=ue;

module.exports = Ge;
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.js.map